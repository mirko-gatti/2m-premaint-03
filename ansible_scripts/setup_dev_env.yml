---
- name: Setup Development Environment
  hosts: localhost
  connection: local
  gather_facts: true

  vars_files:
    - ../config/setup-config.yaml

  pre_tasks:
    - name: Set ansible_user if not defined
      ansible.builtin.set_fact:
        ansible_user: "{{ lookup('env', 'USER') }}"
      when: ansible_user is not defined
      tags:
        - always

  roles:
    - role: install_tools
    - role: setup_docker
    - role: setup_udev_user
    - role: run_influxdb
    - role: run_grafana
    - role: motor_ingestion

  post_tasks:
    - name: Wait for Docker daemon to be accessible
      ansible.builtin.wait_for:
        timeout: 10
      tags:
        - influxdb_security
        - grafana_security

    - name: Reset SSH connection to ensure group membership is applied
      ansible.builtin.meta: reset_connection
      tags:
        - influxdb_security
        - grafana_security

    - name: Run InfluxDB security initialization
      ansible.builtin.command: "{{ playbook_dir }}/../scripts/influxdb-init.sh"
      register: influxdb_init_result
      changed_when: false
      become: true
      tags:
        - influxdb_security

    - name: Validate InfluxDB initialization
      ansible.builtin.assert:
        that:
          - influxdb_init_result.rc == 0
        fail_msg: "InfluxDB initialization failed. Check the output above."
        success_msg: "InfluxDB initialization completed successfully."
      tags:
        - influxdb_security

    - name: Run Grafana security initialization
      ansible.builtin.command: "{{ playbook_dir }}/../scripts/grafana-init.sh"
      register: grafana_init_result
      changed_when: false
      become: true
      tags:
        - grafana_security

    - name: Validate Grafana initialization
      ansible.builtin.assert:
        that:
          - grafana_init_result.rc == 0
        fail_msg: "Grafana initialization failed. Check the output above."
        success_msg: "Grafana initialization completed successfully."
      tags:
        - grafana_security

    - name: Verify InfluxDB initialization completed
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../.influxdb-initialized"
      register: influxdb_init_marker
      tags:
        - influxdb_security

    - name: Verify Grafana initialization completed
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../.grafana-initialized"
      register: grafana_init_marker
      tags:
        - grafana_security

    - name: Display setup completion information
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "  Development Environment Setup Complete!"
          - "========================================="
          - ""
          - "Containers Running:"
          - "  - InfluxDB (port 8181): http://localhost:8181"
          - "  - Grafana (port 3000): http://localhost:3000"
          - "  - Motor Ingestion: Ready for Python scripts"
          - ""
          - "Security Configuration:"
          - "  - InfluxDB tokens: .influxdb-*-token files"
          - "  - Grafana tokens: .grafana-*-token files"
          - ""
          - "Data Directories:"
          - "  - InfluxDB: /home/udev1/influxdb-data"
          - "  - Grafana: /home/udev1/grafana-data"
          - "  - Motor Ingestion: /home/udev1/motor_ingestion"
          - ""
          - "Next Steps:"
          - "  1. Access Grafana: http://localhost:3000"
          - "  2. Access InfluxDB: http://localhost:8181"
          - "  3. Configure datasources if needed"
          - "  4. Deploy motor ingestion Python scripts"
          - ""
          - "To teardown: ansible-playbook -i inventory/hosts teardown_dev_env.yml --ask-become-pass"
          - "========================================="
      tags:
        - always
